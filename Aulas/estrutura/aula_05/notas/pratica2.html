<!DOCTYPE html>
<html lang="pt-BR">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>Notas dos Alunos (com forEach)</title>
</head>

<body>
   <h2>Notas dos Alunos</h2>

   <button onclick="calcularMediaNotas()">
      1 – Calcular Média por Nota (Linha)
   </button>
   <button onclick="calcularMediaAlunos()">
      2 – Calcular Média por Aluno (Coluna)
   </button>

   <table border="1px" width="100%" id="tabelaNotas">
      <thead>
         <tr bgcolor="gray">
            <th rowspan="2">Aluno</th>
            <th colspan="3">Semestre 1</th>
            <th colspan="3">Semestre 2</th>
            <th colspan="3">Semestre 3</th>
         </tr>
         <tr>
            <th>Nota 1</th>
            <th>Nota 2</th>
            <th>Nota 3</th>
            <th>Nota 1</th>
            <th>Nota 2</th>
            <th>Nota 3</th>
            <th>Nota 1</th>
            <th>Nota 2</th>
            <th>Nota 3</th>
         </tr>
      </thead>
      <tbody>
         <tr>
            <td>João</td>
            <td>10</td>
            <td>8</td>
            <td>9</td>
            <td>6</td>
            <td>8,7</td>
            <td>10</td>
            <td>6</td>
            <td>7</td>
            <td>9</td>
         </tr>
         <tr>
            <td>Maria</td>
            <td>9</td>
            <td>7,5</td>
            <td>8</td>
            <td>9</td>
            <td>10</td>
            <td>8,5</td>
            <td>7</td>
            <td>8</td>
            <td>9</td>
         </tr>
         <tr>
            <td>José</td>
            <td>6</td>
            <td>5</td>
            <td>7</td>
            <td>8</td>
            <td>6,5</td>
            <td>7</td>
            <td>8</td>
            <td>9</td>
            <td>10</td>
         </tr>
         <tr>
            <td>Paulo</td>
            <td>8</td>
            <td>8</td>
            <td>8</td>
            <td>7</td>
            <td>7</td>
            <td>7</td>
            <td>9</td>
            <td>9</td>
            <td>9</td>
         </tr>
         <tr>
            <td>Miguel</td>
            <td>10</td>
            <td>10</td>
            <td>9,5</td>
            <td>9</td>
            <td>8</td>
            <td>7</td>
            <td>6</td>
            <td>6,5</td>
            <td>5</td>
         </tr>
         <tr>
            <td>Julia</td>
            <td>7</td>
            <td>8,2</td>
            <td>9</td>
            <td>8</td>
            <td>7</td>
            <td>10</td>
            <td>9</td>
            <td>8</td>
            <td>7</td>
         </tr>
      </tbody>
   </table>

   <script>
      const parseNota = (texto) => parseFloat(texto.replace(",", "."));

      function calcularMediaNotas() {
         if (document.getElementById("linhaMedia")) {
            alert("A linha de médias já foi adicionada.");
            return;
         }

         const tabela = document.getElementById("tabelaNotas");
         const corpoTabela = tabela.tBodies[0];
         const linhasDeDados = Array.from(corpoTabela.rows);

         const numColunasNotas = tabela.rows[1].cells.length;
         const dadosColunas = Array(numColunasNotas)
            .fill(0)
            .map(() => ({ soma: 0, validos: 0 }));

         linhasDeDados.forEach((linha) => {
            const celulasDeNota = Array.from(linha.cells).slice(1);

            celulasDeNota.forEach((celula, indiceColuna) => {
               if (celula && celula.innerHTML.trim() !== "") {
                  dadosColunas[indiceColuna].soma += parseNota(celula.innerHTML);
                  dadosColunas[indiceColuna].validos++;
               }
            });
         });

         const novaLinha = corpoTabela.insertRow();
         novaLinha.id = "linhaMedia";
         novaLinha.style.fontWeight = "bold";
         novaLinha.style.backgroundColor = "#f2f2f2";
         novaLinha.insertCell().innerHTML = "Média Geral";

         dadosColunas.forEach((coluna) => {
            let media = coluna.validos > 0 ? coluna.soma / coluna.validos : 0;
            novaLinha.insertCell().innerHTML = media.toFixed(2).replace(".", ",");
         });
      }

      function calcularMediaAlunos() {
         const tabela = document.getElementById("tabelaNotas");

         if (document.getElementById("colunaMediaHeader")) {
            alert("A coluna de médias já foi adicionada.");
            return;
         }

         const headerRow = tabela.rows[0];
         const novoHeader = document.createElement("th");

         novoHeader.innerHTML = "Média do Aluno";
         novoHeader.rowSpan = 2;
         novoHeader.bgColor = "gray";
         novoHeader.id = "colunaMediaHeader";
         headerRow.appendChild(novoHeader);

         const todasAsLinhas = Array.from(tabela.rows).slice(2); // Pula as 2 linhas de cabeçalho

         todasAsLinhas.forEach((linha) => {
            const celulasDeNota = Array.from(linha.cells).slice(1);

            const totais = celulasDeNota.reduce(
               (acc, celula) => {
                  if (celula && celula.innerHTML.trim() !== "") {
                     acc.soma += parseNota(celula.innerHTML);
                     acc.validos++;
                  }
                  return acc;
               },
               { soma: 0, validos: 0 }
            );

            const media = totais.validos > 0 ? totais.soma / totais.validos : 0;
            const novaCelula = linha.insertCell();

            novaCelula.innerHTML = media.toFixed(2).replace(".", ",");
            novaCelula.style.fontWeight = "bold";
            novaCelula.style.backgroundColor = "#f2f2f2";
         });
      }
   </script>
</body>

</html>